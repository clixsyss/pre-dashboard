# Mobile App Integration Guide

This guide explains how the mobile app should interact with the same Firebase database to manage guest passes.

## ⚠️ CRITICAL: Block Status Synchronization

**IMPORTANT**: The mobile app MUST use the provided API functions to check user eligibility. Direct Firebase queries may not reflect the latest block status set by admins in the dashboard.

### ✅ DO THIS:
```javascript
import { checkUserEligibility, createGuestPass } from './api/guestPassAPI';

// Always check eligibility first
const result = await checkUserEligibility(projectId, userId);
if (!result.success || !result.data.canGenerate) {
  // User is blocked or has reached limit
  return;
}
```

### ❌ DON'T DO THIS:
```javascript
// Direct Firebase query - may not show latest block status
const userDoc = await getDoc(doc(db, 'users', userId));
if (userDoc.data().guestPassData?.blocked) {
  // This might be outdated!
}
```

## 🔄 Data Flow

1. **Mobile App** checks user eligibility using API (CRITICAL)
2. **Mobile App** generates guest passes and QR codes
3. **Mobile App** creates records in Firebase collections
4. **Dashboard** reads and displays the data in real-time
5. **Mobile App** updates pass status after sending via WhatsApp

## 📊 Firebase Collections

### 1. Users Collection (`users`)

The mobile app should add guest pass data to existing user records in the main users collection:

```javascript
// When user first accesses guest passes in mobile app
const userRef = doc(db, 'users', userId);
const userDoc = await getDoc(userRef);

if (userDoc.exists()) {
  const userData = userDoc.data();
  const guestPassData = userData.guestPassData || {};
  
  await updateDoc(userRef, {
    guestPassData: {
      ...guestPassData,
      monthlyLimit: 100, // Default limit
      usedThisMonth: 0,
      blocked: false,
      updatedAt: serverTimestamp()
    },
    updatedAt: serverTimestamp()
  });
}
```

### 2. Guest Passes (`guestPasses`)

The mobile app creates pass records when generating guest passes:

```javascript
// When generating a guest pass
const passId = `GP-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`.toUpperCase();

const passRef = doc(db, 'guestPasses');
const passData = {
  id: passId,
  projectId: 'project123',
  userId: 'user456',
  userName: 'John Doe',
  createdAt: serverTimestamp(),
  sentStatus: false,
  sentAt: null,
  qrCodeUrl: 'data:image/png;base64,...', // QR code generated by mobile app
  updatedAt: serverTimestamp()
};

await setDoc(passRef, passData);

// Update user's usage count
const userRef = doc(db, 'guestPassUsers', 'user456');
await updateDoc(userRef, {
  usedThisMonth: increment(1),
  updatedAt: serverTimestamp()
});
```

### 3. Guest Pass Settings (`guestPassSettings`)

The dashboard creates settings when first accessed, but mobile app can read them:

```javascript
// Read global settings
const settingsRef = doc(db, 'guestPassSettings', 'project123');
const settingsDoc = await getDoc(settingsRef);

if (settingsDoc.exists()) {
  const settings = settingsDoc.data();
  console.log('Global monthly limit:', settings.monthlyLimit);
}
```

## 🔧 Mobile App Implementation

### Check User Eligibility

```javascript
import { doc, getDoc, query, collection, where, getDocs } from 'firebase/firestore';

const checkUserEligibility = async (projectId, userId) => {
  // Check if user exists and is not blocked
  const userRef = doc(db, 'users', userId);
  const userDoc = await getDoc(userRef);
  
  if (!userDoc.exists()) {
    throw new Error('User not found');
  }
  
  const userData = userDoc.data();
  const guestPassData = userData.guestPassData || { blocked: false, monthlyLimit: 100, usedThisMonth: 0 };
  
  if (guestPassData.blocked) {
    throw new Error('User is blocked from generating passes');
  }
  
  // Check monthly limit
  const now = new Date();
  const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  
  const passesQuery = query(
    collection(db, 'guestPasses'),
    where('projectId', '==', projectId),
    where('userId', '==', userId),
    where('createdAt', '>=', startOfMonth)
  );
  
  const passesSnapshot = await getDocs(passesQuery);
  
  if (passesSnapshot.size >= guestPassData.monthlyLimit) {
    throw new Error('User has reached their monthly limit');
  }
  
  return {
    canGenerate: true,
    usedThisMonth: passesSnapshot.size,
    remainingQuota: guestPassData.monthlyLimit - passesSnapshot.size
  };
};
```

### Generate Guest Pass

```javascript
import { collection, addDoc, updateDoc, increment, serverTimestamp } from 'firebase/firestore';

const generateGuestPass = async (projectId, userId, userName) => {
  // Check eligibility first
  await checkUserEligibility(projectId, userId);
  
  // Generate unique pass ID
  const passId = `GP-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`.toUpperCase();
  
  // Generate QR code (your QR generation logic here)
  const qrCodeUrl = await generateQRCode(passId);
  
  // Create pass record
  const passRef = await addDoc(collection(db, 'guestPasses'), {
    id: passId,
    projectId,
    userId,
    userName,
    createdAt: serverTimestamp(),
    sentStatus: false,
    sentAt: null,
    qrCodeUrl,
    updatedAt: serverTimestamp()
  });
  
  // Update user's usage count in guestPassData
  const userRef = doc(db, 'users', userId);
  const userDoc = await getDoc(userRef);
  
  if (userDoc.exists()) {
    const userData = userDoc.data();
    const guestPassData = userData.guestPassData || { usedThisMonth: 0 };
    
    await updateDoc(userRef, {
      guestPassData: {
        ...guestPassData,
        usedThisMonth: guestPassData.usedThisMonth + 1,
        updatedAt: serverTimestamp()
      },
      updatedAt: serverTimestamp()
    });
  }
  
  return {
    passId,
    qrCodeUrl,
    passRef: passRef.id
  };
};
```

### Mark Pass as Sent

```javascript
const markPassAsSent = async (passRefId) => {
  const passRef = doc(db, 'guestPasses', passRefId);
  
  await updateDoc(passRef, {
    sentStatus: true,
    sentAt: serverTimestamp(),
    updatedAt: serverTimestamp()
  });
  
  console.log('Pass marked as sent successfully');
};
```

### Send via WhatsApp

```javascript
const sendPassViaWhatsApp = async (passData, phoneNumber) => {
  try {
    // Your WhatsApp integration logic here
    const message = `Guest Pass: ${passData.passId}\nQR Code attached.`;
    
    // Send via WhatsApp (your implementation)
    const result = await sendWhatsAppMessage(phoneNumber, message, passData.qrCodeUrl);
    
    if (result.success) {
      // Mark as sent in Firebase
      await markPassAsSent(passData.passRef);
      return { success: true, message: 'Pass sent successfully' };
    } else {
      throw new Error('Failed to send via WhatsApp');
    }
  } catch (error) {
    console.error('Error sending pass:', error);
    throw error;
  }
};
```

## 📱 Complete Flow Example

```javascript
const handleGenerateAndSendPass = async () => {
  try {
    const projectId = 'project123';
    const userId = 'user456';
    const userName = 'John Doe';
    const phoneNumber = '+1234567890';
    
    // 1. Check if user can generate a pass
    const eligibility = await checkUserEligibility(projectId, userId);
    console.log(`User can generate ${eligibility.remainingQuota} more passes`);
    
    // 2. Generate the pass
    const passData = await generateGuestPass(projectId, userId, userName);
    console.log('Pass generated:', passData.passId);
    
    // 3. Send via WhatsApp
    const result = await sendPassViaWhatsApp(passData, phoneNumber);
    
    if (result.success) {
      console.log('Pass sent and marked as sent in dashboard');
      // Show success message to user
    }
  } catch (error) {
    console.error('Error:', error.message);
    // Show error message to user
  }
};
```

## 🔒 Security Rules

Make sure your Firebase security rules allow the mobile app to read/write:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow mobile app users to read/write their own data
    match /guestPassUsers/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow mobile app to create passes for authenticated users
    match /guestPasses/{passId} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
    }
    
    // Allow reading settings
    match /guestPassSettings/{projectId} {
      allow read: if request.auth != null;
    }
  }
}
```

## 📊 Dashboard Integration

The dashboard will automatically:

- **Real-time Updates**: Show new passes as they're created
- **Status Tracking**: Display sent status when mobile app updates it
- **Analytics**: Calculate statistics from the Firebase data
- **User Management**: Show usage limits and blocking status
- **Admin Controls**: Allow admins to manage limits and block users

## 🎯 Key Points

1. **Same Database**: Both mobile app and dashboard use the same Firebase project
2. **Real-time Sync**: Changes in mobile app appear immediately in dashboard
3. **No API Layer**: Direct Firebase access for both applications
4. **Project Scoped**: All data is isolated per project
5. **Status Tracking**: Mobile app updates pass status after sending

The dashboard will automatically reflect all changes made by the mobile app in real-time!
